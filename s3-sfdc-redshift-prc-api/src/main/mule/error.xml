<?xml version="1.0" encoding="UTF-8"?>

<mule xmlns:cloudhub="http://www.mulesoft.org/schema/mule/cloudhub"
	xmlns:http="http://www.mulesoft.org/schema/mule/http" xmlns:os="http://www.mulesoft.org/schema/mule/os"
	xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core"
	xmlns:s3="http://www.mulesoft.org/schema/mule/s3" xmlns:redshift="http://www.mulesoft.org/schema/mule/redshift" xmlns:salesforce="http://www.mulesoft.org/schema/mule/salesforce" xmlns:secure-properties="http://www.mulesoft.org/schema/mule/secure-properties" xmlns="http://www.mulesoft.org/schema/mule/core" xmlns:doc="http://www.mulesoft.org/schema/mule/documentation" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="
http://www.mulesoft.org/schema/mule/http http://www.mulesoft.org/schema/mule/http/current/mule-http.xsd http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
http://www.mulesoft.org/schema/mule/secure-properties http://www.mulesoft.org/schema/mule/secure-properties/current/mule-secure-properties.xsd
http://www.mulesoft.org/schema/mule/salesforce http://www.mulesoft.org/schema/mule/salesforce/current/mule-salesforce.xsd
http://www.mulesoft.org/schema/mule/redshift http://www.mulesoft.org/schema/mule/redshift/current/mule-redshift.xsd
http://www.mulesoft.org/schema/mule/s3 http://www.mulesoft.org/schema/mule/s3/current/mule-s3.xsd
http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd
http://www.mulesoft.org/schema/mule/os http://www.mulesoft.org/schema/mule/os/current/mule-os.xsd
http://www.mulesoft.org/schema/mule/cloudhub http://www.mulesoft.org/schema/mule/cloudhub/current/mule-cloudhub.xsd">
	<sub-flow name="On-error-continue-for-For-Each" doc:id="7888da87-16a6-4c2f-8f61-0e0e8d5ff1f2" >
		<logger level="INFO" doc:name="Error from For Each" doc:id="51b9e769-5b0a-41a7-82d6-f43be9d21d73" message="#[%dw 2.0&#10;&#10;output application/json&#10;&#10;---&#10;&#10;if((error.exception.cause.cause.localizedMessage default &quot;&quot; contains (&quot;Amazon&quot;)) or (error.exception.cause.cause.localizedMessage default &quot;&quot; contains (&quot;amazon&quot;)))&#10;&#10;{  &quot;stage&quot; : &quot;Error from S3 connector in For Each&quot;,&#10;&#10;	&quot;file&quot;: payload,&#10;&#10;	error: error.exception.cause.cause.message,&#10;&#10;	'type':error.exception.cause.cause.errorCode default error.errorType.parentErrorType.identifier,&#10;&#10;	timestamp: now(),&#10;	&quot;correlationId&quot;: correlationId,&#10;&#10;	&quot;level&quot;:&quot;info&quot;&#10;&#10;}&#10;&#10;else&#10;&#10;{  &quot;stage&quot; : &quot;Error from For Each&quot;,&#10;&#10;	error: error.description,&#10;&#10;	'type': error.errorType.identifier,&#10;&#10;	timestamp: now(),&#10;	&quot;correlationId&quot;: correlationId,&#10;&#10;	&quot;level&quot;:&quot;info&quot;&#10;&#10;}]"/>
	
</sub-flow>
	<sub-flow name="On-error-propagate-for-SALESFORCE" doc:id="85dc0cab-e1dd-4779-97e8-8297a5c0a87e" >
		<logger level="INFO" doc:name="Logger Error from SALESFORCE SAPI" doc:id="115118f3-aa37-4d03-b5be-982b0e11268d" message="#[%dw 2.0&#10;output application/json&#10;---&#10;{  &#10;	&quot;stage&quot; : &quot;Error from HTTP request to SALESFORCE system API&quot;,&#10;	&quot;type&quot;: vars.error.error.'type',&#10;	&quot;error&quot;: vars.error.error.message,&#10;	timestamp: now(),&#10;	&quot;correlationId&quot;: correlationId,&#10;	&quot;level&quot;:&quot;info&quot;&#10;}]"/>
		<cloudhub:create-notification doc:name="Create Notification" doc:id="16cc051b-0cfb-4d30-8a63-039769c3ae0b" config-ref="CloudHub_Config" domain="${domain}" priority="ERROR">
			<reconnect frequency="${cloudhub.reconnection.frequency}" count="${cloudhub.reconnection.attempts}" />
					<cloudhub:message><![CDATA[#[output application/json
---
"SALESFORCE- " ++ ((vars.error.error.message as String) default "")]]]></cloudhub:message>
		</cloudhub:create-notification>
	
</sub-flow>
	<sub-flow name="On-error-propagate-for-REDSHIFT" doc:id="caab0ccb-5d58-4eed-b4b7-bc1ecfdedb1b" >
		<logger level="INFO" doc:name="Logger Error from REDSHIFT" doc:id="13c3d19d-c03f-47fe-99cb-21a95a2905ca" message="#[%dw 2.0&#10;&#10;output application/json&#10;&#10;---&#10;&#10;{  &quot;stage&quot; : &quot;Error from HTTP request to REDSHIFT system API&quot;,&#10;&#10;	&quot;type&quot;:vars.error.error.'type' ,&#10;	&#10;	&quot;error&quot;:vars.error.error.message,&#10;&#10;	timestamp: now(),&#10;&#10;	&quot;correlationId&quot;: correlationId,&#10;&#10;&#10;&#10;	&quot;level&quot;:&quot;info&quot;&#10;&#10;}]" />
		<scatter-gather doc:name="Scatter-Gather" doc:id="f7175dfd-6598-4221-b55f-714d969756d1" >
			<route >
				<ee:transform doc:name="DW error payload of Redshift deployment" doc:id="a20bc4fc-13d3-4e93-bdc2-4d350d49f623" >
					<ee:message >
					</ee:message>
					<ee:variables >
						<ee:set-variable resource="dwl/var_redshiftErrDep.dwl" variableName="intLogDep" />
					</ee:variables>
				</ee:transform>
				<remove-variable doc:name="Remove Variable" doc:id="63e86ad4-25a8-4140-bd78-abe49ca9140b" variableName="error"/>
				<flow-ref doc:name="ref to salesforce-interface-logs-for-deployment-subflow" doc:id="486f1a84-8649-4750-a991-00195bee4f5f" name="salesforce-interface-logs-for-deployment-subflow"/>
			</route>
			<route >
				<ee:transform doc:name="DW error payload of Redshift account" doc:id="54b40358-80d5-45d6-8a62-d16a53e9d0df" >
					<ee:message >
					</ee:message>
					<ee:variables >
						<ee:set-variable resource="dwl/var_redshiftErrAcc.dwl" variableName="intLogAcc" />
					</ee:variables>
				</ee:transform>
				<remove-variable doc:name="Remove Variable" doc:id="38035c50-1725-4afd-8973-c07c249b6240" variableName="error"/>
				<flow-ref doc:name="ref to salesforce-interface-logs-for-account-subflow" doc:id="27869550-59e4-4e9a-a47d-030f442d841c" name="salesforce-interface-logs-for-account-subflow"/>
			</route>
		</scatter-gather>
	
</sub-flow>
	<error-handler name="globalError_Handler" doc:id="52da60c1-c7bd-4ce1-befe-b3309f68e5a2" >
		<on-error-propagate enableNotifications="true" logException="true" doc:name="On Error Propagate" doc:id="e37937a6-50f2-4414-a4b4-18ff2bd3a71e" type="ANY">
			<choice doc:name="Choice" doc:id="4acce1b4-f783-42ca-b0b0-fed4bfd076ed" >
				<when expression='#[(error.exception.cause.cause.localizedMessage default "" contains ("Amazon")) or (error.exception.cause.cause.localizedMessage default "" contains ("amazon"))]'>
					<logger level="INFO" doc:name="Logger S3 error handler" doc:id="12c2da39-820e-44a4-bd59-5cf68acee14f" message="#[%dw 2.0
&#10;output application/json
&#10;---
&#10;{  &quot;stage&quot; : &quot;Error from S3 bucket&quot;,
&#10;	error: error.exception.cause.cause.message,
&#10;	'type': error.exception.cause.cause.errorCode default error.errorType.parentErrorType.identifier,
&#10;	timestamp: now(),
&#10;	&quot;correlationId&quot;: correlationId,&#10;&#10;	&quot;level&quot;:&quot;info&quot;&#10;&#10;}]"/>
					<scatter-gather doc:name="Scatter-Gather" doc:id="a514885f-1259-4485-ab54-19a9e3ff33ee" >
						<route >
							<ee:transform doc:name="DW S3 error payload Deployment" doc:id="3cbda813-d7f6-4816-aab7-d5353d29961c" >
								<ee:message >
								</ee:message>
								<ee:variables >
									<ee:set-variable resource="dwl/var_s3_listAccErr.dwl" variableName="intLogDep" />
								</ee:variables>
							</ee:transform>
							<flow-ref doc:name="ref to salesforce-interface-logs-for-deployment-subflow" doc:id="aac70698-cde8-4e92-8e42-36856db9b27e" name="salesforce-interface-logs-for-deployment-subflow"/>
						</route>
						<route >
							<ee:transform doc:name="DW S3 error payload account" doc:id="73f6c338-cc1f-442e-af59-948e16e9199e" >
								<ee:message >
								</ee:message>
								<ee:variables >
									<ee:set-variable resource="dwl/var_s3_listErr.dwl" variableName="intLogAcc" />
								</ee:variables>
							</ee:transform>
							<flow-ref doc:name="ref to salesforce-interface-logs-for-account-subflow" doc:id="6090a068-9e63-4c4b-a4b1-2114ae958b0d" name="salesforce-interface-logs-for-account-subflow"/>
						</route>
					</scatter-gather>
				
</when>
				<otherwise >
					<logger level="INFO" doc:name="Logger generic error handler" doc:id="d09c4ca4-b234-4a42-8bb8-cd7907720bb1" message="#[%dw 2.0
&#10;output application/json
&#10;---
&#10;{ &quot;stage&quot; : &quot;Generic error&quot;,
&#10;	error: error.description,
&#10;	'type': error.errorType.identifier,
&#10;	timestamp: now(),
&#10;	&quot;correlationId&quot;: correlationId,
&#10;	&quot;level&quot;:&quot;info&quot;
&#10;}]"/>
				<scatter-gather doc:name="Scatter-Gather" doc:id="554df35b-d792-41ee-80f7-a036103c59dc" >
						<route >
							<ee:transform doc:name="DW generic error payload Deployment" doc:id="8ac2cc1e-30ea-458c-b9b7-3725885dca41" >
								<ee:message >
								</ee:message>
								<ee:variables >
									<ee:set-variable resource="dwl/var_s3_listAccErr.dwl" variableName="intLogDep" />
								</ee:variables>
							</ee:transform>
							<flow-ref doc:name="ref to salesforce-interface-logs-for-deployment-subflow" doc:id="b7293375-437c-4128-ae3b-43f762a56deb" name="salesforce-interface-logs-for-deployment-subflow"/>
						</route>
						<route >
							<ee:transform doc:name="DW generic error payload account" doc:id="e8bbfd42-5225-42f0-981f-d10639610632" >
								<ee:message >
								</ee:message>
								<ee:variables >
									<ee:set-variable resource="dwl/var_s3_listErr.dwl" variableName="intLogAcc" />
								</ee:variables>
							</ee:transform>
							<flow-ref doc:name="ref to salesforce-interface-logs-for-account-subflow" doc:id="d8d9e093-a784-45d1-ab20-461121039bdf" name="salesforce-interface-logs-for-account-subflow"/>
						</route>
					</scatter-gather>
</otherwise>
			</choice>
		</on-error-propagate>
	</error-handler>
</mule>
